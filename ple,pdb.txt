CREATE OR REPLACE FUNCTION generar_ple(INTEGER,INTEGER) RETURNS TABLE(_1,_2,_3,_4,_5,_6,_7,_8,_9,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_20,_21,_22,_23,_24,_25,_26,_27,_28,_29,_30,_31,_32,_33,_34,_35,_36,_37) LANGUAGE plpgsql AS
$$
DECLARE

BEGIN

SELECT rpad(periodo_tributario,8,'0') AS Clm_1, CONCAT(,to_char(fecha_emision, 'DD/MM/YYYY') AS Clm_4,to_char(fecha_vencimiento, 'DD/MM/YYYY') AS Clm_5,to_char(tipo_comprobante, 'fm00') AS Clm_6,lpad(numero_serie, 4, '0') AS Clm_7,numero_correlativo AS Clm_8,numero_final AS Clm_9,tipo_documento AS Clm_10,numero_documento AS Clm_11,(SELECT nombre_razon FROM related WHERE numero_documento = v.numero_documento) AS Clm_12,(CASE WHEN tipo_operacion = 17 AND tipo_comprobante <> 7 THEN valor WHEN tipo_operacion = 18 AND tipo_comprobante = 7 THEN (valor * -1) ELSE null END) AS Clm_13,(CASE WHEN tipo_operacion <> 17 AND tipo_comprobante <> 7 AND destino <> 2 THEN valor WHEN tipo_operacion <> 17 AND tipo_comprobante = 7 AND destino <> 2 AND (SELECT (to_char(fecha_emision,'YYYYMM')::integer) FROM _5 WHERE cui = (CONCAT(v.subdiario,ltrim(to_char(v.entity_id,'000')),ltrim(to_char(v.tipo_comprobante_modificado,'00')),v.numero_serie_modificado,v.numero_correlativo_modificado))) = 202201 THEN (valor * -1) ELSE null END) AS Clm_14,(CASE WHEN tipo_operacion <> 17 AND tipo_comprobante = 7 AND destino <> 2 AND (SELECT (to_char(fecha_emision,'YYYYMM')::integer) FROM _5 WHERE cui = (CONCAT(v.subdiario,ltrim(to_char(v.entity_id,'000')),ltrim(to_char(v.tipo_comprobante_modificado,'00')),v.numero_serie_modificado,v.numero_correlativo_modificado))) <> 202201 THEN (valor * -1) ELSE null END) AS Clm_15,ROUND((CASE WHEN tipo_operacion <> 17 AND tipo_comprobante <> 7 AND destino <> 2 THEN valor WHEN tipo_operacion <> 17 AND tipo_comprobante = 7 AND destino <> 2 AND (SELECT (to_char(fecha_emision,'YYYYMM')::integer) FROM _5 WHERE cui = (CONCAT(v.subdiario,ltrim(to_char(v.entity_id,'000')),ltrim(to_char(v.tipo_comprobante_modificado,'00')),v.numero_serie_modificado,v.numero_correlativo_modificado))) = 202201 THEN (valor * -1) ELSE null END) * 0.18,2) AS Clm_16,ROUND((CASE WHEN tipo_operacion <> 17 AND tipo_comprobante = 7 AND destino <> 2 AND (SELECT (to_char(fecha_emision,'YYYYMM')::integer) FROM _5 WHERE cui = (CONCAT(v.subdiario,ltrim(to_char(v.entity_id,'000')),ltrim(to_char(v.tipo_comprobante_modificado,'00')),v.numero_serie_modificado,v.numero_correlativo_modificado))) <> 202201 THEN (valor * -1) ELSE null END) * 0.18,2) AS Clm_17,(CASE WHEN tipo_operacion <> 17 AND destino = 2 THEN valor WHEN tipo_operacion <> 17 AND destino = 3 THEN otros_cargos ELSE null END) AS Clm_18,(CASE WHEN (tipo_operacion <> 17 AND destino = 2 AND observaciones LIKE '%inafecto%') THEN valor ELSE null END) AS Clm_19,isc AS Clm_20,(CASE WHEN tipo_comprobante = 6 THEN valor ELSE null END) AS Clm_21,ROUND((CASE WHEN tipo_comprobante = 6 THEN valor ELSE null END) * 0.18,2) AS Clm_22,icbp AS Clm_23,(CASE WHEN tipo_operacion <> 17 AND destino <> 3 THEN otros_cargos ELSE null END) AS Clm_24,tipo_moneda AS Clm_26,(CASE WHEN tipo_moneda = 'USD' THEN to_char((SELECT usd_s FROM tc WHERE fecha_sunat = fecha_emision), 'l9D999') ELSE to_char(1, 'l9D999') END) AS Clm_27,(SELECT to_char(fecha_emision, 'DD/MM/YYYY') FROM _5 WHERE cui = (CONCAT(v.subdiario,ltrim(to_char(v.entity_id,'000')),ltrim(to_char(v.tipo_comprobante_modificado,'00')),v.numero_serie_modificado,v.numero_correlativo_modificado))) AS Clm_28,to_char(tipo_comprobante_modificado, 'fm00') AS Clm_29,numero_serie_modificado AS Clm_30, numero_correlativo_modificado AS Clm_31,(SELECT observaciones FROM acc._5 WHERE observaciones LIKE '%contrato%') AS Clm_32,null AS Clm_33,(CASE WHEN (medio_pago <> 9 AND medio_pago <> 8) THEN 1 ELSE null END) AS Clm_33,(CASE WHEN (tipo_operacion = 0 AND (to_char(fecha_emision,'YYYYMM')::integer) = 202201) THEN '0' WHEN (tipo_operacion <> 0 AND (to_char(fecha_emision,'YYYYMM')::integer) = 202201) THEN '1' WHEN fecha_emision IS null THEN '2' END) AS Clm_34 FROM acc._5 v WHERE entity_id = 1 AND periodo_tributario = 202201;

SELECT rpad(periodo_tributario,8,'0') AS Clm_1, to_char(fecha_emision, 'DD/MM/YYYY') AS Clm_4,to_char(fecha_vencimiento, 'DD/MM/YYYY') AS Clm_5,to_char(tipo_comprobante, 'fm00') AS Clm_6,lpad(numero_serie, 4,'0') AS Clm_7,(CASE WHEN (tipo_comprobante = 50 OR tipo_comprobante = 52) THEN importe_final ELSE null END) AS Clm_8,numero_correlativo AS Clm_9,importe_final AS Clm_10,tipo_documento AS Clm_11,numero_documento AS Clm_12,(SELECT nombre_razon FROM related WHERE numero_documento = c.numero_documento) AS Clm_13,(CASE WHEN tipo_operacion <> 18 AND tipo_comprobante <> 7 AND destino = 1 THEN valor WHEN tipo_operacion <> 18 AND tipo_comprobante = 7 AND destino = 1 THEN (valor * -1) ELSE null END) AS Clm_14,ROUND((CASE WHEN tipo_operacion <> 18 AND tipo_comprobante <> 7 AND destino = 1 THEN valor WHEN tipo_operacion <> 18 AND tipo_comprobante = 7 AND destino = 1 THEN (valor * -1) ELSE null END) * 0.18,2) AS Clm_15,(CASE WHEN tipo_operacion <> 18 AND tipo_comprobante <> 7 AND destino = 2 THEN valor WHEN tipo_operacion <> 18 AND tipo_comprobante = 7 AND destino = 2 THEN (valor * -1) ELSE null END) AS Clm_16,ROUND((CASE WHEN tipo_operacion <> 18 AND tipo_comprobante <> 7 AND destino = 2 THEN valor WHEN tipo_operacion <> 18 AND tipo_comprobante = 7 AND destino = 2 THEN (valor * -1) ELSE null END) * 0.18,2) AS Clm_17,(CASE WHEN tipo_operacion <> 18 AND tipo_comprobante <> 7 AND destino = 3 THEN valor WHEN tipo_operacion <> 18 AND tipo_comprobante = 7 AND destino = 3 THEN (valor * -1) ELSE null END) AS Clm_18,ROUND((CASE WHEN tipo_operacion <> 18 AND tipo_comprobante <> 7 AND destino = 3 THEN valor WHEN tipo_operacion <> 18 AND tipo_comprobante = 7 AND destino = 3 THEN (valor * -1) ELSE null END) * 0.18,2) AS Clm_19,(CASE WHEN tipo_operacion <> 18 AND destino = 4 THEN valor WHEN tipo_operacion <> 18 AND destino = 5 THEN otros_cargos ELSE null END) AS Clm_20,isc AS Clm_21,icbp AS Clm_22,(CASE WHEN destino <> 5 THEN otros_cargos ELSE null END) AS Clm_23,tipo_moneda AS Clm_25,(CASE WHEN tipo_moneda = 'USD' THEN to_char((SELECT usd_s FROM tc WHERE fecha_sunat = fecha_emision), 'l9D999') ELSE to_char(1, 'l9D999') END) AS Clm_26,(SELECT to_char(fecha_emision, 'DD/MM/YYYY') FROM _8 WHERE cui = (CONCAT(c.subdiario,ltrim(to_char(c.entity_id,'000')),ltrim(to_char(c.tipo_comprobante_modificado,'00')),c.numero_serie_modificado,c.numero_correlativo_modificado))) AS Clm_27,to_char(tipo_comprobante_modificado, 'fm00') AS Clm_28,numero_serie_modificado AS Clm_29,(CASE WHEN observaciones LIKE '%dependencia%' AND tipo_operacion = 18 THEN observaciones ELSE null END) AS Clm_30,numero_correlativo_modificado AS Clm_31,(CASE WHEN tasa_detraccion IS NOT null THEN (SELECT fecha_operacion FROM acc._2 WHERE cui_relacionado = c.cui AND entidad_financiera = 18) ELSE null END) AS Clm_32,(CASE WHEN tasa_detraccion IS NOT null THEN (SELECT numero_operacion FROM _2 WHERE cui_relacionado = c.cui AND entidad_financiera = 18) ELSE null END) AS Clm_33,(CASE WHEN observaciones LIKE 'retencion' THEN 1 ELSE null END) AS Clm_34,clasificacion_bienes_servicios AS Clm_35,(SELECT observaciones FROM _8 WHERE observaciones LIKE '%contrato%') AS Clm_36,null AS Clm_37,null AS Clm_38,null AS Clm_39,null AS Clm_40,(CASE WHEN (medio_pago <> 9 AND medio_pago <> 8) THEN 1 ELSE null END) AS Clm_41,(CASE WHEN tipo_comprobante = 3 THEN 1 WHEN (tipo_operacion <> 3 AND (to_char(fecha_emision,'YYYYMM')::integer) = 202201) THEN 1 WHEN (tipo_operacion <> 3 AND (to_char(fecha_emision,'YYYYMM')::integer) < 202201) THEN 6 WHEN (tipo_operacion <> 3 AND (to_char(fecha_emision + interval '1 year','YYYYMM')::integer) < 202201) THEN 7 END) AS Clm_42 FROM acc._8 c WHERE entity_id = 1 AND periodo_tributario = 202201;




